{% extends "page_layout/layout.html" %}

{% block title %} {{ super() }}  {% endblock %}
{% block css_or_js_code %}
    <!-- add js, css code or library as need. js code is recommended in at footer 
        This code will be add to the head of the page
    -->

{% endblock  css_or_js_code %}
{% block main_content %}
<!-- main content code will be add here -->

<div class="box">
    <div class="box-header with-border">
      <h4 class="box-title text-primary font-weight-bold ">Position and Salary Settings</h4>
    </div>
    <div class="box-body">
        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item"> <a class="nav-link active" data-toggle="tab" href="#postition-tab" role="tab"><span class="hidden-sm-up"><i class="fa fa-cc"></i></span> <span class="hidden-xs-down">Assigned Positions</span></a> </li>
            <li class="nav-item"> <a class="nav-link" data-toggle="tab" href="#salay-tab" role="tab"><span class="hidden-sm-up"><i class="fa fa-paypal"></i></span> <span class="hidden-xs-down">Assigned Salary</span></a> </li>
        </ul>
        
        <!-- Tab panes -->
        <div class="tab-content">
            <div class="tab-pane active" id="postition-tab" role="tabpanel">
                <div class="">
                    <div class="box">
                        <!-- <div class="box-header with-border">
                            <h4 class="box-title text-primary"></h4>
                          </div> -->
                          <div class="box-body table-responsive">
                            <table class="table table-striped table-hover mb-4">
                                <thead>
                                    <tr>
                                        <th colspan="4" class="bg-info-light"> 
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <span>{{translation.employee_id[language]}}: </span> <span class="text-mute">{{contract[1].id }}</span> 
                                                    <span class="text-primary mx-2"> | </span>
                                                    <span>
                                                        {{translation.first_name[language]}}:</span> <span class="text-mute">{{contract[1].name_english 
                                                        +' '+ contract[1].lname_english if language == 'en' else contract[1].name 
                                                        +' '+ contract[1].lname }}
                                                    </span>
                                                </div>
                                                <div class="col-md-6">
                                                    <span>{{translation.phone[language]}}:</span>
                                                    <span class="text-mute">
                                                         {{contract[2].phone }}
                                                    </span>
                                                    <span class="text-primary mx-2"> | </span>
                                                    <span>{{translation.email[language]}}:</span>
                                                    <span class="text-mute">
                                                         {{contract[3].email }}
                                                    </span>
                                                </div>
                                            </div>
                                            
                                            
                                        </th>
                                    </tr>
                                    <tr>
                                        <th>Positions</th>
                                        <th>Departments</th>
                                        <th>status</th>
                                        <th>Operation</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if position %}
                                        {% for pos in position %}
                                        <tr id="{{pos[0].id}}">
                                            <td>
                                                {{pos[1].name}}
                                            </td>
                                            <td>
                                                {{pos[2].name}}
                                            </td>
                                            <td>
                                                {{translation.active[language] if pos[0].status else translation.inactive[language] }}
                                            </td>
                                            <td>
                                                {% if  pos[0].status %}
                                                <a href="javascript:void(0)" onclick="updatePosition('{{pos[0].id}}')">
                                                    <i class="fad fa-edit text-info"></i>
                                                </a>
                                                <span> | </span>
                                                <a href="javascript:void(0)">
                                                    <i class="fad fa-trash-alt text-danger" onclick="deletePosition('{{pos[0].id}}')"></i>
                                                </a>
                                                {% else %}
                                                    <span class="text-mute small">No Operations</span>
                                                {% endif%}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    {% endif %}
                                </tbody>
                            </table>
                            <br>
                            <div class="mt-4 pt-2">
                                <button type="button" id="assign-new-position" class="btn btn-outline-primary" data-toggle="modal" data-target=".add_position_modal"><i class="fad fa-plus"></i> Assign New Position </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-pane" id="salay-tab" role="tabpanel">						
                <div class=""> 
                    <div class="box">
                        <!-- <div class="box-header with-border">
                            <h4 class="box-title text-primary">Assigned Salary</h4>
                          </div> -->
                          <div class="box-body table-responsive">
                            <table class="table table-hover table-striped">
                                <thead>
                                    <tr>
                                        <th colspan="9" class="bg-info-light"> 
                                            <div class="row ">
                                                <div class="col-md-4 p-md-2 p-sm-2">
                                                    <span>{{translation.employee_id[language]}}: </span> <span class="text-mute">{{contract[1].id }}</span> 
                                                    <span class="text-primary mx-2"> | </span>
                                                    <span>
                                                        {{translation.first_name[language]}}:</span> <span class="text-mute">{{contract[1].name_english 
                                                        +' '+ contract[1].lname_english if language == 'en' else contract[1].name 
                                                        +' '+ contract[1].lname }}
                                                    </span>
                                                </div>
                                                <div class="col-md-4 p-md-2 p-sm-2">
                                                    <span>{{translation.phone[language]}}:</span>
                                                    <span class="text-muted">
                                                         {{contract[2].phone }}
                                                    </span>
                                                    <span class="text-primary mx-2"> | </span>
                                                    <span>{{translation.email[language]}}:</span>
                                                    <span class="text-muted">
                                                         {{contract[3].email }}
                                                    </span>
                                                </div>
                                                <div class="col-md-4 p-md-2 p-sm-2">
                                                    <span>{{translation.current_position[language]}}:</span>
                                                    <span class="text-muted">
                                                         {{current_position[1].name_english if language == 'en' else current_position[1].name}}
                                                    </span><span class="text-primary mx-2"> | </span>
                                                    <span>{{translation.department[language]}}:</span>
                                                    <span class="text-muted">
                                                         {{current_position[2].name_english if language == 'en' else current_position[2].name}}
                                                    </span>
                                                </div>
                                            </div>
                                            
                                            
                                            

                                        </th>
                                    </tr>
                                    <tr>
                                        <th>No</th>
                                        <th>{{ translation.base_salary[language]  }}</th>
                                        <th> {{ translation.transportation[language]  }} </th>
                                        <th>{{ translation.house_hold[language]  }}</th>
                                        <th>{{ translation.currency[language]  }}</th>
                                        <th>Position Salary</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Operations</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if salary %}
                                    {% for sal in salary %}
                                    <tr id="{{sal[0].id}}">
                                        <td>{{loop.index}}</td>
                                        <td>{{sal[0].base}}</td>
                                        <td>{{sal[0].transportation}}</td>
                                        <td>{{sal[0].house_hold}}</td>
                                        <td>
                                            {% if sal[0].currency == "1"%}
                                            {{translation.afghani[language]}}
                                            {% else %}
                                            {{translation.dollar[language]}}
                                            {% endif %}
                                        </td>
                                        <td>{{sal[2].name_english if language == 'en' else sal[2].name}}</td>
                                        <td>{{sal[0].salary_change_date}}</td>
                                        <td>
                                            {{translation.active[language] if sal[0].status else translation.inactive[language] }}
                                        </td>
                                        <td>
                                            {% if  sal[0].status and contract[0].status %}
                                            <a href="javascript:void(0)" onclick="updateSalary('{{sal[0].id}}')">
                                                <i class="fad fa-edit text-info"></i>
                                            </a>
                                            <span> | </span>
                                            <a href="javascript:void(0)">
                                                <i class="fad fa-trash-alt text-danger" onclick="deleteSalary('{{sal[0].id}}')"></i>
                                            </a>
                                            {% else %}
                                                <span class="text-mute small">No Operations</span>
                                            {% endif%}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                    {% endif %}
                                </tbody>
                            </table>
                            <br>
                            <div class="mt-4 pt-2">
                                <button type="button" id="assign-new-salary" class="btn btn-outline-primary" data-toggle="modal" data-target=".add_salary_modal"><i class="fad fa-plus"></i> Assign New Position </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        
    </div>
    <!-- /.box-body -->
    
</div>


<!-- updating contract salary and position modal start -->
<div class="modal fade edit_position_salary_modal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true" style="display: none;">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title text-primary box-title" id="myLargeModalLabel">
                    {{translation.contract_salary_update[language]}}
                </h4>
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
            </div>
            <div class="modal-body box box-body" id="postion_salary_modal_content">
                <div class="text-center" id="loader_salary"></div>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->
<!-- updating contract  position modal start -->
<div class="modal fade add_position_modal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true" style="display: none;">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title text-primary box-title" id="myLargeModalLabel">
                    {{translation.contract_position_add[language]}}
                </h4>
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
            </div>
            <div class="modal-body" id="add_position_modal_content">
                <div class="box " id="new-position">
                    <div class="box-body">
                        <form action="/contract_new_position" method="POST" id="new-position-form">
                            {{ position_form.hidden_tag()}}
                            
                            <div class="form-group">
                                {{position_form.position.label(class='form-control-label')}}
                                {{position_form.position(class='form-control')}}
                            </div>
                            <div class="form-group">
                                {{position_form.department.label(class='form-control-label')}}
                                {{position_form.department(class='form-control')}}
                            </div>
                            <div class="form-group">
                                {{position_form.position_date_change.label(class='form-control-label')}}
                                <div class="input-group" id="position_date_change_icon">
                                    <div class="input-group-prepend">
                                        <span class="{{ 'border-radius-dari' if language == 'dari' }} input-group-text bg-transparent">
                                            <i class="fad fa-calendar"></i>
                                        </span>
                                    </div>
                                    {{position_form.position_date_change(class='form-control')}}
                                </div>
                            </div>
                            <div class="form-group">
                                {{ position_form.submit(class='btn btn-primary')}}
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->
<!-- add contract salary  start -->
<div class="modal fade add_salary_modal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true" style="display: none;">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title text-primary box-title" id="myLargeModalLabel">
                    {{translation.contract_salary_add[language]}}
                </h4>
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
            </div>
            <div class="modal-body" id="add_salary_modal_content">
                <div class="box" id="new-salary">
                    
                    <div class="box-body">
                        <form action="/contract_new_salary" method="POST" id="new-salary-form">
                            {{ salary_form.hidden_tag()}}
                            {# <div class="form-group">
                                {{salary_form.position.label(class="form-control-label")}} 
                                {{salary_form.position(class='form-control')}}
                                <span class="text-muted small text-info"> Position must be the current and active position </span>
                            </div> #}
                            <div class="form-group">
                                {{salary_form.base.label(class='form-control-label')}}
                                {{salary_form.base(class='form-control')}}
                            </div>
                            <div class="form-group">
                                {{salary_form.transportation.label(class='form-control-label')}}
                                {{salary_form.transportation(class='form-control')}}
                            </div>
                            <div class="form-group">
                                {{salary_form.house_hold.label(class='form-control-label')}}
                                {{salary_form.house_hold(class='form-control')}}
                            </div>
                            <div class="col-md-6 form-group">
                                {{ salary_form.currency.label(class='form-check-label')}} <br>
                                {% for radio in salary_form.currency %}
                                {{ radio(class="form-check-input")}}
                                {{ radio.label(class="form-check-label")}}
                                {% endfor %}
                              </div>
    
                            <div class="form-group">
                                {{salary_form.salary_date_change.label(class='form-control-label')}}
                                <div class="input-group" id="salary_date_change_icon">
                                    <div class="input-group-prepend">
                                        <span class="{{ 'border-radius-dari' if language == 'dari' }} input-group-text bg-transparent">
                                            <i class="fad fa-calendar"></i>
                                        </span>
                                    </div>
                                    {{salary_form.salary_date_change(class='form-control')}}
                                </div>
                            </div>
                            <div class="form-group">
                                {{ salary_form.submit(class='btn btn-primary')}}

                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

{% endblock main_content%}
{% block js_code %}
    <!-- 
        add js code or library here as need 
        This code will be add to the footer of the page
    -->
    <script src="{{url_for('static', filename='assets/vendor_components/jquery-toast-plugin-master/src/jquery.toast.js')}}"></script>
    <script src="{{url_for('static', filename='js/rpc.js')}}"></script>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {%if messages %}
            {%for category, message in messages %} 
            <!-- <div class="alert alert-{{category}}"> {{message}} </div> -->
            <script>
                $(document).ready(function() {
                    var message = JSON.parse('{{ message | tojson | safe}}');
                    if("{{category}}" == "success")

                        toastSuccess("{{message}}")
                    else
                    msg = formValidationDisplay(message);
                    toastError(msg)
                }); 
                
            </script>
            {% endfor %}
        {% endif %}
    {% endwith %}


    <script>
        $(document).ready(function(){
           // $("#assign-new-position").click(function(){
              //  $("#new-position").toggleClass('d-none')
           // });
           // $("#assign-new-salary").click(function(){
             //   $("#new-salary").toggleClass('d-none')
           // });

            $('#position_date_change_icon').MdPersianDateTimePicker({
                targetTextSelector: '#position_date_change',
                textFormat: 'yyyy-MM-dd',
                isGregorian: false,
                englishNumber: true,
                enableTimePicker: false,
            });
            $('#salary_date_change_icon').MdPersianDateTimePicker({
                targetTextSelector: '#salary_date_change',
                textFormat: 'yyyy-MM-dd',
                isGregorian: false,
                englishNumber: true,
                enableTimePicker: false,
            });
        });

        var updateSalary = function(salary_id){
            spinner = "<i class='fad fa-spinner fa-spin text-info'></i>";
            $('#loader_salary').html(spinner);
            $('.edit_position_salary_modal').modal('show');
            $.ajax({
                type: "GET",
                url: "/edit_contract_salary?salary_id="+salary_id,
                // data: {'user_id':userID},
                processData: false,
                contentType: false,
                success: function (response) {
                    console.log(response)
                    $('#postion_salary_modal_content').html(response)    
                },
            });
        }
        var updatePosition = function(position_id){
            spinner = "<i class='fad fa-spinner fa-spin text-info'></i>";
            $('#loader_position').html(spinner);
            $('.edit_position_salary_modal').modal('show');
            $.ajax({
                type: "GET",
                url: "/edit_contract_position?position_id="+position_id,
                // data: {'user_id':userID},
                processData: false,
                contentType: false,
                success: function (response) {
                    console.log(response)
                    $('#postion_salary_modal_content').html(response)    
                },
            });
        }
        var deletePosition = function(position_id){
            if(confirm('Are you sure you want to delete this Position?')){
                $.ajax({
                    method: 'GET',
                    url: '/delete_position?position_id='+position_id,
                    contentType:false,
                    processData:false,
                    success: function(response){
                        console.log(response)
                        $('#'+position_id).addClass('bg-danger').fadeOut(3000);
                        toastSuccess(response.message);
                    },error: function(response){
                        var statusCode = response.status;
                        var r = '';
                        if(statusCode == '403'){
                            r = formValidateErrors(response);
                        }
                        toastError(r);
                    }
                });
            }
        };
        var deleteSalary = function(salary_id){
            if(confirm('Are you sure you want to delete this Salary?')){
                $.ajax({
                    method: 'GET',
                    url: '/delete_salary?salary_id='+salary_id,
                    contentType:false,
                    processData:false,
                    success: function(response){
                        console.log(response)
                        $('#'+salary_id).addClass('bg-danger').fadeOut(3000);
                        toastSuccess(response.message);
                    },error: function(response){
                        var statusCode = response.status;
                        var r = '';
                        if(statusCode == '403'){
                            r = formValidateErrors(response);
                        }
                        toastError(r);
                    }
                });
            }
        };
    </script>
{% endblock js_code %}